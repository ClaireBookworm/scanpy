<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>scanpy.external.pp.bbknn &mdash; Scanpy 1.9.0.dev72+g7b22b756 documentation</title>

<link rel=stylesheet href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6/dist/cdn/docsearch.min.css"/>

      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/scanpy.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/typehints.css" type="text/css" />
      <link rel="stylesheet" href="https://assets.readthedocs.com/css/badge_only.css" type="text/css" />
    <link rel="canonical" href="https://scanpy.readthedocs.io/en/stable/generated/scanpy.external.pp.bbknn.html" />

  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://assets.readthedocs.com/javascript/readthedocs-doc-embed.js"></script>
    <script src="../_static/js/theme.js"></script>

<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6/dist/cdn/docsearch.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => docsearch({
    apiKey: 'fa4304eb95d2134997e3729553a674b2',
    indexName: 'scanpy',
    inputSelector: '#rtd-search-form > input[name="q"]',
    algoliaOptions: {
      facetFilters: ['version:latest'],
      hitsPerPage: 10,
    },
    debug: false,
  }))
</script>


    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="scanpy.external.pp.harmony_integrate" href="scanpy.external.pp.harmony_integrate.html" />
    <link rel="prev" title="External API" href="../external.html" />
 



<!-- RTD Extra Head -->

<link rel="stylesheet" href="https://assets.readthedocs.com/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.com", "build_date": "2022-03-03T15:00:08Z", "builder": "sphinx", "canonical_url": null, "commit": "7b22b756", "docroot": "/docs/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-2", "language": "en", "page": "generated/scanpy.external.pp.bbknn", "programming_language": "py", "project": "icb-scanpy", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "scanpydoc", "user_analytics_code": "", "version": "latest"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="https://assets.readthedocs.com/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/Scanpy_Logo_BrightFG.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage-principles.html">Usage Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../external.html">External API</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../external.html#preprocessing-pp">Preprocessing: PP</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../external.html#data-integration">Data integration</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">scanpy.external.pp.bbknn</a></li>
<li class="toctree-l4"><a class="reference internal" href="scanpy.external.pp.harmony_integrate.html">scanpy.external.pp.harmony_integrate</a></li>
<li class="toctree-l4"><a class="reference internal" href="scanpy.external.pp.mnn_correct.html">scanpy.external.pp.mnn_correct</a></li>
<li class="toctree-l4"><a class="reference internal" href="scanpy.external.pp.scanorama_integrate.html">scanpy.external.pp.scanorama_integrate</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../external.html#sample-demultiplexing-doublet-detection">Sample demultiplexing, Doublet detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../external.html#imputation">Imputation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../external.html#tools-tl">Tools: TL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../external.html#plotting-pl">Plotting: PL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../external.html#exporting">Exporting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ecosystem.html">Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../news.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Scanpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../external.html">External API</a> &raquo;</li>
      <li>scanpy.external.pp.bbknn</li>
      <li class="wy-breadcrumbs-aside">
              <!-- User defined GitHub URL -->
              <a href="https://github.com/theislab/scanpy/tree/master/scanpy/external/pp/_bbknn.py#L14-L152" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="scanpy-external-pp-bbknn">
<h1>scanpy.external.pp.bbknn<a class="headerlink" href="#scanpy-external-pp-bbknn" title="Permalink to this headline"></a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="scanpy.external.pp.bbknn">
<span class="sig-prename descclassname"><span class="pre">scanpy.external.pp.</span></span><span class="sig-name descname"><span class="pre">bbknn</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">adata</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">batch_key</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'batch'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_rep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'X_pca'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">approx</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_annoy</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metric</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'euclidean'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">copy</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">neighbors_within_batch</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">3</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_pcs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">50</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">trim</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">annoy_n_trees</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pynndescent_n_neighbors</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">30</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pynndescent_random_state</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">use_faiss</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">set_op_mix_ratio</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">local_connectivity</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#scanpy.external.pp.bbknn" title="Permalink to this definition"></a></dt>
<dd><p>Batch balanced kNN <a class="reference internal" href="../references.html#polanski19" id="id1"><span>[Polanski19]</span></a>.</p>
<p>Batch balanced kNN alters the kNN procedure to identify each cell’s top neighbours in
each batch separately instead of the entire cell pool with no accounting for batch.
The nearest neighbours for each batch are then merged to create a final list of
neighbours for the cell. Aligns batches in a quick and lightweight manner.</p>
<p>For use in the scanpy workflow as an alternative to <a class="reference internal" href="scanpy.pp.neighbors.html#scanpy.pp.neighbors" title="scanpy.pp.neighbors"><code class="xref py py-func docutils literal notranslate"><span class="pre">neighbors()</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is just a wrapper of <a class="reference external" href="https://bbknn.readthedocs.io/en/latest/index.html#bbknn.bbknn" title="(in BBKNN)"><code class="xref py py-func docutils literal notranslate"><span class="pre">bbknn.bbknn()</span></code></a>: up to date docstring,
more information and bug reports there.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>adata</strong></dt><dd><p>Needs the PCA computed and stored in <code class="docutils literal notranslate"><span class="pre">adata.obsm[&quot;X_pca&quot;]</span></code>.</p>
</dd>
<dt><strong>batch_key</strong></dt><dd><p><code class="docutils literal notranslate"><span class="pre">adata.obs</span></code> column name discriminating between your batches.</p>
</dd>
<dt><strong>use_rep</strong></dt><dd><p>The dimensionality reduction in <code class="docutils literal notranslate"><span class="pre">.obsm</span></code> to use for neighbour detection. Defaults to PCA.</p>
</dd>
<dt><strong>approx</strong></dt><dd><p>If <code class="docutils literal notranslate"><span class="pre">True</span></code>, use approximate neighbour finding - annoy or pyNNDescent. This results
in a quicker run time for large datasets while also potentially increasing the degree of
batch correction.</p>
</dd>
<dt><strong>use_annoy</strong></dt><dd><p>Only used when <code class="docutils literal notranslate"><span class="pre">approx=True</span></code>. If <code class="docutils literal notranslate"><span class="pre">True</span></code>, will use annoy for neighbour finding. If
<code class="docutils literal notranslate"><span class="pre">False</span></code>, will use pyNNDescent instead.</p>
</dd>
<dt><strong>metric</strong></dt><dd><p><p>What distance metric to use. The options depend on the choice of neighbour algorithm.</p>
<p>”euclidean”, the default, is always available.</p>
<p>Annoy supports “angular”, “manhattan” and “hamming”.</p>
<p>PyNNDescent supports metrics listed in <code class="docutils literal notranslate"><span class="pre">pynndescent.distances.named_distances</span></code>
and custom functions, including compiled Numba code.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pynndescent</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">named_distances</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">dict_keys([&#39;euclidean&#39;, &#39;l2&#39;, &#39;sqeuclidean&#39;, &#39;manhattan&#39;, &#39;taxicab&#39;, &#39;l1&#39;, &#39;chebyshev&#39;, &#39;linfinity&#39;,</span>
<span class="go">&#39;linfty&#39;, &#39;linf&#39;, &#39;minkowski&#39;, &#39;seuclidean&#39;, &#39;standardised_euclidean&#39;, &#39;wminkowski&#39;, &#39;weighted_minkowski&#39;,</span>
<span class="go">&#39;mahalanobis&#39;, &#39;canberra&#39;, &#39;cosine&#39;, &#39;dot&#39;, &#39;correlation&#39;, &#39;hellinger&#39;, &#39;haversine&#39;, &#39;braycurtis&#39;, &#39;spearmanr&#39;,</span>
<span class="go">&#39;kantorovich&#39;, &#39;wasserstein&#39;, &#39;tsss&#39;, &#39;true_angular&#39;, &#39;hamming&#39;, &#39;jaccard&#39;, &#39;dice&#39;, &#39;matching&#39;, &#39;kulsinski&#39;,</span>
<span class="go">&#39;rogerstanimoto&#39;, &#39;russellrao&#39;, &#39;sokalsneath&#39;, &#39;sokalmichener&#39;, &#39;yule&#39;])</span>
</pre></div>
</div>
<p>KDTree supports members of the <code class="docutils literal notranslate"><span class="pre">sklearn.neighbors.KDTree.valid_metrics</span></code> list, or parameterised
<code class="docutils literal notranslate"><span class="pre">sklearn.neighbors.DistanceMetric</span></code> <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.DistanceMetric.html">objects</a>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sklearn</span><span class="o">.</span><span class="n">neighbors</span><span class="o">.</span><span class="n">KDTree</span><span class="o">.</span><span class="n">valid_metrics</span>
<span class="go">[&#39;p&#39;, &#39;chebyshev&#39;, &#39;cityblock&#39;, &#39;minkowski&#39;, &#39;infinity&#39;, &#39;l2&#39;, &#39;euclidean&#39;, &#39;manhattan&#39;, &#39;l1&#39;]</span>
</pre></div>
</div>
</p>
</dd>
<dt><strong>copy</strong></dt><dd><p>If <code class="docutils literal notranslate"><span class="pre">True</span></code>, return a copy instead of writing to the supplied adata.</p>
</dd>
<dt><strong>neighbors_within_batch</strong></dt><dd><p>How many top neighbours to report for each batch; total number of neighbours in
the initial k-nearest-neighbours computation will be this number times the number
of batches. This then serves as the basis for the construction of a symmetrical
matrix of connectivities.</p>
</dd>
<dt><strong>n_pcs</strong></dt><dd><p>How many dimensions (in case of PCA, principal components) to use in the analysis.</p>
</dd>
<dt><strong>trim</strong></dt><dd><p>Trim the neighbours of each cell to these many top connectivities. May help with
population independence and improve the tidiness of clustering. The lower the value the
more independent the individual populations, at the cost of more conserved batch effect.
If <code class="docutils literal notranslate"><span class="pre">None</span></code>, sets the parameter value automatically to 10 times <code class="docutils literal notranslate"><span class="pre">neighbors_within_batch</span></code>
times the number of batches. Set to 0 to skip.</p>
</dd>
<dt><strong>annoy_n_trees</strong></dt><dd><p>Only used with annoy neighbour identification. The number of trees to construct in the
annoy forest. More trees give higher precision when querying, at the cost of increased
run time and resource intensity.</p>
</dd>
<dt><strong>pynndescent_n_neighbors</strong></dt><dd><p>Only used with pyNNDescent neighbour identification. The number of neighbours to include
in the approximate neighbour graph. More neighbours give higher precision when querying,
at the cost of increased run time and resource intensity.</p>
</dd>
<dt><strong>pynndescent_random_state</strong></dt><dd><p>Only used with pyNNDescent neighbour identification. The RNG seed to use when creating
the graph.</p>
</dd>
<dt><strong>use_faiss</strong></dt><dd><p>If <code class="docutils literal notranslate"><span class="pre">approx=False</span></code> and the metric is “euclidean”, use the faiss package to compute
nearest neighbours if installed. This improves performance at a minor cost to numerical
precision as faiss operates on float32.</p>
</dd>
<dt><strong>set_op_mix_ratio</strong></dt><dd><p>UMAP connectivity computation parameter, float between 0 and 1, controlling the
blend between a connectivity matrix formed exclusively from mutual nearest neighbour
pairs (0) and a union of all observed neighbour relationships with the mutual pairs
emphasised (1)</p>
</dd>
<dt><strong>local_connectivity</strong></dt><dd><p>UMAP connectivity computation parameter, how many nearest neighbors of each cell
are assumed to be fully connected (and given a connectivity value of 1)</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The <code class="docutils literal notranslate"><span class="pre">adata</span></code> with the batch-corrected graph.</p>
</dd>
</dl>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../external.html" class="btn btn-neutral float-left" title="External API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="scanpy.external.pp.harmony_integrate.html" class="btn btn-neutral float-right" title="scanpy.external.pp.harmony_integrate" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, the Scanpy development team..
      <span class="commit">Revision <code>7b22b756</code>.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.com/projects/icb-scanpy/?fromdocs=icb-scanpy">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.com/builds/icb-scanpy/?fromdocs=icb-scanpy">Builds</a>
          </dd>
      </dl>
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>